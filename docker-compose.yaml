services:
  tgtorrentbot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    image: tgtorrentbot_img:latest
    container_name: tgt-bot
    environment:
      - TGT_BOTTOKEN=${BOT_TOKEN}
      - TGT_ALLOWED_USERS=${ALLOWED_USERS}
      - TGT_WEBHOOKURL=${WEBHOOKURL}
      - TGT_DOWNLOADPATH=/downloads
      - TGT_RPC_ADDR=http://tgt-transmission:9091/transmission/rpc
      - TGT_RPC_USER=tgtorrentbot
      - TGT_RPC_PASSWORD=${PASSWD}
      - TGT_RUTRACKER_USERNAME=${RUTRACKER_USERNAME}
      - TGT_RUTRACKER_PASSWORD=${RUTRACKER_PASSWORD}
      - TGT_LOGLEVEL=debug
      - TGT_WEBAPP_URL=${WEBAPP_URL}
    cap_add:
      - NET_BIND_SERVICE
    volumes:
      - /var/transmission/downloads:/downloads
    dns:
      - 8.8.8.8
      - 8.8.4.4
    restart: unless-stopped
    networks:
      - tunnel-net
    logging:
      options:
        max-size: "5m"
        max-file: "3"

  tgtorrentbot-webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    image: tgtorrentbot-webapp_img:latest
    container_name: tgt-webapp
    environment:
      - TGT_BOTTOKEN=${BOT_TOKEN}
      - TGT_ALLOWED_USERS=${ALLOWED_USERS}
      - TGT_DOWNLOADPATH=/downloads
      - TGT_RPC_ADDR=http://tgt-transmission:9091/transmission/rpc
      - TGT_RPC_USER=tgtorrentbot
      - TGT_RPC_PASSWORD=${PASSWD}
      - TGT_RUTRACKER_USERNAME=${RUTRACKER_USERNAME}
      - TGT_RUTRACKER_PASSWORD=${RUTRACKER_PASSWORD}
      - TGT_JELLYFIN_URL=http://tgt-jellyfin:8096
      - TGT_JELLYFIN_API_KEY=${JELLYFIN_API_KEY}
      - TGT_INCOMPLETE_PATH=/downloads/incomplete
      - PORT=8080
    volumes:
      - /var/transmission/downloads:/downloads:ro
    dns:
      - 8.8.8.8
      - 8.8.4.4
    restart: unless-stopped
    networks:
      - tunnel-net
    logging:
      options:
        max-size: "5m"
        max-file: "3"

  transmission:
    image: lscr.io/linuxserver/transmission
    container_name: tgt-transmission
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Canada/Eastern
      - USER=tgtorrentbot
      - PASS=${PASSWD}
    volumes:
      - /var/transmission/config:/config
      - /var/transmission/downloads:/downloads
      - /var/transmission/watch:/watch
    networks:
      - tunnel-net
    ports:
      - 9091:9091
      # - 51413:51413
      # - 51413:51413/udp
    restart: unless-stopped
    logging:
      options:
        max-size: "5m"
        max-file: "3"

  #minidlna:
    #image: vladgh/minidlna
    #container_name: tgt-dlna
    #network_mode: "host"
    #environment:
      #- MINIDLNA_MEDIA_DIR=/media
      #- MINIDLNA_FRIENDLY_NAME=Raspberry
    #volumes:
      #- /var/transmission/downloads/movies:/media/movies
      #- /var/transmission/downloads/shows:/media/shows
      #- /var/transmission/downloads/music:/media/music
      #- /var/transmission/downloads/audiobooks:/media/audiobooks
      #- /var/transmission/downloads/others:/media/others
    #restart: unless-stopped

  #samba:
    #image: dperson/samba:latest
    #container_name: tgt-samba
    #ports:
      #- "137:137/udp"
      #- "138:138/udp"
      #- "139:139/tcp"
      #- "445:445/tcp"
    #read_only: true
    #tmpfs:
      #- /tmp
    #stdin_open: true
    #tty: true
    #volumes:
      #- /var/transmission/downloads/movies:/media/movies:z
      #- /var/transmission/downloads/shows:/media/shows:z
      #- /var/transmission/downloads/music:/media/music:z
      #- /var/transmission/downloads/audiobooks:/media/audiobooks:z
      #- /var/transmission/downloads/others:/media/others:z
    #command: '-s "media;/media" -n'
    #restart: unless-stopped
    #logging:
      #options:
        #max-size: "5m"
        #max-file: "3"

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: tgt-jellyfin
    networks:
      - tunnel-net
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Canada/Eastern
    volumes:
      - /var/jellyfin/config:/config
      - /var/transmission/downloads/movies:/media/movies
      - /var/transmission/downloads/shows:/media/shows
      - /var/transmission/downloads/music:/media/music
      - /var/transmission/downloads/musicvideos:/media/musicvideos
      - /var/transmission/downloads/audiobooks:/media/audiobooks
      - /var/transmission/downloads/others:/media/others
    ports:
      - 8096:8096
      - 8920:8920
    restart: unless-stopped
    logging:
      options:
        max-size: "5m"
        max-file: "3"

  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: tgt-cloudflare-tunnel
    command: tunnel --no-autoupdate run --token ${TUNNEL_TOKEN}
    networks:
      - tunnel-net
    restart: unless-stopped
    depends_on:
      - jellyfin
      - tgtorrentbot
      - tgtorrentbot-webapp
    logging:
      options:
        max-size: "5m"
        max-file: "2"

networks:
  tunnel-net:
    driver: bridge
